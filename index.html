<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Report Viewer</title>
    
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <!-- Power BI JavaScript SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.23.1/powerbi.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background-color: #0078d4;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .config-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f8f9fa;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
        }
        
        .config-item label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .config-item input, .config-item select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        
        .embed-btn {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .embed-btn:hover {
            background-color: #106ebe;
        }
        
        .embed-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        #embedContainer {
            width: 100%;
            height: 600px;
            border: none;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
        }
        
        .rotation-controls {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: none;
        }
        
        .rotation-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-info {
            font-weight: 600;
            color: #333;
        }
        
        .rotation-status {
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            #embedContainer {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Power BI Report Viewer</h1>
            <p>Visualizador de relatórios Power BI com rotação automática de páginas</p>
        </div>
        
        <div class="config-section">
            <div class="config-grid">
                <div class="config-item">
                    <label for="embedUrl">Link do Power BI:</label>
                    <input type="url" id="embedUrl" value="https://app.powerbi.com/reportEmbed?reportId=e3f6d65d-753d-4498-8521-d87f5ffcdee5&autoAuth=true&embeddedDemo=true&reportSection=ReportSection" placeholder="Cole o link do Power BI aqui">
                </div>
                
                <div class="config-item">
                    <label for="username">Usuário (opcional):</label>
                    <input type="email" id="username" value="nexo@consilcontabilidade.com" placeholder="seu@email.com">
                </div>
            </div>
            
            <button class="embed-btn" onclick="embedReport()">Carregar Relatório</button>
            <button class="embed-btn" onclick="openInNewTab()" style="background-color: #28a745; margin-left: 10px;">Abrir no Power BI</button>
            
            <div id="status" class="status" style="display: none;"></div>
        </div>
        
        <div id="embedContainer">
            Configurar os dados acima e clicar em "Carregar Relatório" para visualizar
        </div>
        
        <div class="rotation-controls" id="rotationControls">
            <div class="rotation-info">
                <span class="page-info" id="pageInfo">Página: -</span>
                <span class="rotation-status">Rotação automática a cada 45 segundos</span>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let report;
        let models;
        let rotationInterval;
        let currentPage = 0;
        let pages = [];
        let loadedResolve, reportLoaded = new Promise((res, rej) => { loadedResolve = res; });
        let renderedResolve, reportRendered = new Promise((res, rej) => { renderedResolve = res; });

        // Função para mostrar status
        function showStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }

        // Função para esconder status
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        // Função para abrir no Power BI
        function openInNewTab() {
            const embedUrl = document.getElementById('embedUrl').value.trim();
            if (embedUrl) {
                window.open(embedUrl, '_blank');
            } else {
                showStatus('Por favor, insira o link do Power BI', 'error');
            }
        }

        // Função para extrair parâmetros da URL
        function parseEmbedUrl(url) {
            try {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                
                return {
                    reportId: params.get('reportId'),
                    baseUrl: urlObj.origin + urlObj.pathname,
                    autoAuth: params.get('autoAuth') === 'true',
                    embeddedDemo: params.get('embeddedDemo') === 'true'
                };
            } catch (error) {
                console.error('Erro ao analisar URL:', error);
                return null;
            }
        }

        // Função principal para embed do relatório
        async function embedReport() {
            try {
                const embedUrlInput = document.getElementById('embedUrl').value.trim();
                const username = document.getElementById('username').value.trim();

                if (!embedUrlInput) {
                    showStatus('Por favor, insira o link do Power BI', 'error');
                    return;
                }

                showStatus('Carregando relatório...', 'loading');

                // Limpar interval anterior se existir
                if (rotationInterval) {
                    clearInterval(rotationInterval);
                }

                // Analisar URL
                const urlData = parseEmbedUrl(embedUrlInput);
                if (!urlData || !urlData.reportId) {
                    showStatus('URL inválida. Verifique o link do Power BI', 'error');
                    return;
                }

                // Obter models do Power BI
                models = window['powerbi-client'].models;

                // Configuração para embed público/demo
                const config = {
                    type: 'report',
                    tokenType: models.TokenType.Anonymous, // Para relatórios públicos
                    embedUrl: urlData.baseUrl,
                    id: urlData.reportId,
                    settings: {
                        panes: {
                            filters: {
                                visible: true
                            },
                            pageNavigation: {
                                visible: true
                            }
                        },
                        bars: {
                            statusBar: {
                                visible: true
                            }
                        },
                        background: models.BackgroundType.Transparent
                    }
                };

                // Se for demo, adicionar configurações específicas
                if (urlData.embeddedDemo) {
                    config.settings.filterPaneEnabled = false;
                    config.settings.navContentPaneEnabled = false;
                }

                // Container do embed
                const embedContainer = document.getElementById('embedContainer');
                embedContainer.innerHTML = ''; // Limpar conteúdo anterior

                try {
                    // Embed do relatório
                    report = powerbi.embed(embedContainer, config);

                    // Event handlers
                    report.off("loaded");
                    report.on("loaded", function () {
                        loadedResolve();
                        report.off("loaded");
                        showStatus('Relatório carregado, renderizando...', 'loading');
                    });

                    report.off("error");
                    report.on("error", function (event) {
                        console.error('Erro no Power BI:', event.detail);
                        // Tentar fallback com iframe
                        showEmbedFallback(embedUrlInput);
                    });

                    report.off("rendered");
                    report.on("rendered", function () {
                        renderedResolve();
                        report.off("rendered");
                    });

                    // Aguardar carregamento e renderização
                    await Promise.race([
                        Promise.all([reportLoaded, reportRendered]),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
                    ]);

                    // Configurar rotação de páginas
                    await setupPageRotation();

                    showStatus('Relatório carregado com sucesso!', 'success');
                    setTimeout(hideStatus, 3000);

                } catch (embedError) {
                    console.log('Embed SDK falhou, tentando fallback com iframe...');
                    showEmbedFallback(embedUrlInput);
                }

            } catch (error) {
                console.error('Erro ao carregar relatório:', error);
                showEmbedFallback(document.getElementById('embedUrl').value.trim());
            }
        }

        // Função fallback usando iframe
        function showEmbedFallback(url) {
            try {
                showStatus('Carregando relatório (modo iframe)...', 'loading');
                
                const embedContainer = document.getElementById('embedContainer');
                
                // Criar iframe
                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.frameBorder = '0';
                iframe.allowFullscreen = true;
                
                // Limpar container e adicionar iframe
                embedContainer.innerHTML = '';
                embedContainer.appendChild(iframe);
                
                // Simular carregamento
                setTimeout(() => {
                    showStatus('Relatório carregado (iframe)!', 'success');
                    setTimeout(hideStatus, 3000);
                    
                    // Esconder controles de rotação para iframe
                    document.getElementById('rotationControls').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Erro no fallback iframe:', error);
                showStatus('Erro ao carregar relatório. Tente abrir diretamente no Power BI', 'error');
            }
        }

        // Função para configurar rotação de páginas
        async function setupPageRotation() {
            try {
                // Obter páginas do relatório
                pages = await report.getPages();
                currentPage = 0;

                if (pages.length > 1) {
                    // Mostrar controles de rotação
                    document.getElementById('rotationControls').style.display = 'block';
                    
                    // Configurar página inicial
                    await pages[0].setActive();
                    updatePageInfo();

                    // Iniciar rotação automática a cada 45 segundos
                    rotationInterval = setInterval(rotatePages, 45000);
                    
                    console.log(`Rotação iniciada com ${pages.length} páginas`);
                } else {
                    // Esconder controles se só há uma página
                    document.getElementById('rotationControls').style.display = 'none';
                    console.log('Apenas uma página encontrada, rotação desabilitada');
                }

            } catch (error) {
                console.error('Erro ao configurar rotação:', error);
            }
        }

        // Função para rotacionar páginas
        async function rotatePages() {
            try {
                if (pages.length <= 1) return;

                // Avançar para próxima página
                currentPage = (currentPage + 1) % pages.length;

                // Navegar para a nova página
                await pages[currentPage].setActive();
                updatePageInfo();
                
                console.log(`Página atual: ${pages[currentPage].displayName}`);
            } catch (error) {
                console.error("Erro ao mudar de página:", error);
            }
        }

        // Função para atualizar informações da página
        function updatePageInfo() {
            if (pages.length > 0) {
                const pageInfo = document.getElementById('pageInfo');
                pageInfo.textContent = `Página: ${pages[currentPage].displayName} (${currentPage + 1}/${pages.length})`;
            }
        }

        // Limpar interval quando a página for fechada
        window.addEventListener('beforeunload', function() {
            if (rotationInterval) {
                clearInterval(rotationInterval);
            }
        });

        // Permitir Enter nos campos de input para carregar relatório
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        embedReport();
                    }
                });
            });
        });
    </script>
</body>
</html>
